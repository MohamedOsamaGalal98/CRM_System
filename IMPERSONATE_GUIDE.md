# شرح ميزة Impersonate (انتحال الهوية) في نظام CRM

## ما هي ميزة Impersonate؟

**انتحال الهوية (Impersonate)** هي ميزة أمنية تسمح للمديرين بالدخول مؤقتاً بحساب مستخدم آخر دون معرفة كلمة المرور الخاصة به.

## متى تستخدم هذه الميزة؟

### 1. **الدعم الفني**
- مساعدة المستخدمين في حل المشاكل
- رؤية ما يراه المستخدم بالضبط
- اختبار الصلاحيات من منظور المستخدم

### 2. **الاختبار**
- اختبار النظام بصلاحيات مختلفة
- التأكد من عمل الميزات لأدوار معينة
- فحص واجهة المستخدم لأدوار مختلفة

### 3. **التدقيق**
- مراجعة ما يمكن للمستخدم الوصول إليه
- التحقق من الأمان والصلاحيات
- فحص البيانات المرئية للمستخدم

## كيف تعمل الميزة؟

### 1. **البدء بانتحال الهوية**
```
المدير → يضغط "انتحال الهوية" → يأخذ هوية المستخدم
```

### 2. **أثناء انتحال الهوية**
- المدير يرى النظام كما يراه المستخدم المحدد
- جميع الصلاحيات تصبح مطابقة للمستخدم المختار
- يظهر تنبيه مستمر يوضح حالة انتحال الهوية

### 3. **إنهاء انتحال الهوية**
- الضغط على زر "إيقاف انتحال الهوية"
- العودة التلقائية لحساب المدير الأصلي

## الصلاحيات المطلوبة

### صلاحية `impersonate_users`
- **Super Admin**: ✅ يمكنه انتحال هوية أي مستخدم
- **Admin**: ✅ يمكنه انتحال هوية المستخدمين العاديين
- **باقي الأدوار**: ❌ لا يمكنهم استخدام هذه الميزة

## الأمان والحماية

### 1. **قيود الأمان**
- لا يمكن للمدير انتحال هوية نفسه
- يتم حفظ هوية المدير الأصلي في الجلسة
- تنبيه مستمر أثناء انتحال الهوية
- سجل للعمليات (يمكن إضافته لاحقاً)

### 2. **التتبع**
```php
// يتم حفظ معرف المدير الأصلي
session(['impersonator_id' => Auth::id()]);
```

### 3. **الإشعارات**
- تنبيه عند بدء انتحال الهوية
- تنبيه مستمر أثناء الاستخدام
- رسالة تأكيد عند الإنهاء

## التطبيق العملي في نظام CRM

### مثال 1: مشكلة مستخدم مبيعات
```
المستخدم: "لا أستطيع رؤية العملاء الجدد"
المدير: ينتحل هوية المستخدم → يرى نفس المشكلة → يحلها
```

### مثال 2: اختبار صلاحيات جديدة
```
المدير: ينتحل هوية "موظف إدخال بيانات" → يختبر الصلاحيات الجديدة
```

### مثال 3: تدريب فريق جديد
```
المدير: ينتحل هوية "مدير مبيعات" → يشرح للفريق ما يمكنهم فعله
```

## الكود المطبق

### 1. **في UserResource**
```php
Tables\Actions\Action::make('impersonate')
    ->label('انتحال الهوية')
    ->visible(fn ($record) => Gate::allows('impersonate_users') && Auth::id() !== $record->id)
    ->requiresConfirmation()
    ->action(function ($record) {
        session(['impersonator_id' => Auth::id()]);
        Auth::login($record);
        // إشعارات وإعادة توجيه
    })
```

### 2. **Controller لإيقاف الانتحال**
```php
public function stopImpersonation() {
    $originalUserId = session('impersonator_id');
    session()->forget('impersonator_id');
    Auth::login(User::find($originalUserId));
    return redirect('/admin/users');
}
```

### 3. **Middleware للتنبيهات**
```php
if (session('impersonator_id')) {
    // عرض تنبيه مستمر
}
```

## كيفية الاستخدام

### للمدير:
1. اذهب إلى `/admin/users`
2. اختر المستخدم المطلوب
3. اضغط "انتحال الهوية"
4. أكد العملية
5. استخدم النظام كالمستخدم المحدد
6. اضغط "إيقاف انتحال الهوية" للعودة

### للمطور:
```bash
# إضافة صلاحية جديدة
Permission::create(['name' => 'impersonate_users']);

# تخصيص الصلاحية لدور
$role->givePermissionTo('impersonate_users');
```

## الاختلاف عن تسجيل الدخول العادي

| العادي | Impersonate |
|--------|-------------|
| يحتاج كلمة مرور | لا يحتاج كلمة مرور |
| دائم | مؤقت |
| لا توجد تنبيهات | تنبيهات مستمرة |
| لا يمكن العودة بسهولة | عودة بضغطة واحدة |

هذه الميزة قوية جداً للدعم الفني وإدارة النظام!
